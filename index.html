<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å´‡è¯åå…­æœŸæ•´åˆç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'æ¨™æ¥·é«”', sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            margin: 0;
            padding-bottom: 80px; 
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active { color: #10b981; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        .btn-primary {
            background-color: #10b981;
            color: white;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        .btn-primary:hover:not(:disabled) { background-color: #059669; transform: translateY(-1px); }
        .btn-primary:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .role-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: bold;
        }
        .role-admin { background-color: #ef4444; color: white; }
        .role-teacher { background-color: #8b5cf6; color: white; }
        .role-leader { background-color: #f59e0b; color: white; }
        .role-user { background-color: #64748b; color: white; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-signed { background-color: #10b981; box-shadow: 0 0 5px #10b981; } 
        .dot-missing { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; } 
        .dot-leave { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }   
        .dot-official { background-color: #3b82f6; box-shadow: 0 0 5px #3b82f6; }
        .dot-late { background-color: #fbbf24; box-shadow: 0 0 5px #fbbf24; }

        .hidden-view { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000; 
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            border-radius: 20px;
            overflow-y: auto;
            padding: 24px;
        }

        .question-card { border-left: 4px solid #10b981; background: white; }

        /* æ¸¬é©—åœ–ç‰‡å°ˆç”¨æ¨£å¼ */
        .quiz-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin: 12px 0;
            cursor: zoom-in;
            border: 1px solid #f1f5f9;
            display: block;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold text-emerald-600">å´‡è¯åå…­æœŸç®¡ç†ç³»çµ±</h1>
        <div id="user-display" class="text-sm font-medium text-slate-600 hidden flex items-center">
            <span id="display-name">è¼‰å…¥ä¸­...</span>
            <span id="display-role" class="role-badge"></span>
            <button onclick="logout()" class="ml-3 text-red-500 hover:underline">ç™»å‡º</button>
        </div>
    </header>

    <main class="container mx-auto max-w-2xl p-4">

        <!-- ç™»å…¥è¦–åœ– -->
        <div id="view-login" class="fade-in py-10">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">å­¸å“¡ç™»å…¥</h2>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400">çµ„åˆ¥</label>
                        <select id="login-group" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">å§“å</label>
                        <select id="login-name" disabled class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">å¯†ç¢¼</label>
                        <input type="password" id="login-pass" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="å¯†ç¢¼">
                    </div>
                    <button onclick="handleLogin()" id="login-btn" class="w-full py-3 btn-primary rounded-lg font-bold">é€²å…¥ç³»çµ±</button>
                    <div class="text-center mt-6 pt-4 border-t border-slate-100">
                        <button onclick="switchView('register')" class="text-sm text-emerald-600 font-bold hover:underline">åˆæ¬¡ä½¿ç”¨ï¼Ÿè¨»å†Šè¨­å®šå¯†ç¢¼</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨»å†Šè¦–åœ– -->
        <div id="view-register" class="hidden-view fade-in py-10">
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">å¸³è™Ÿè¨»å†Š</h2>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400">é¸æ“‡æ‚¨çš„çµ„åˆ¥</label>
                        <select id="reg-group" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">é¸æ“‡æ‚¨çš„å§“å</label>
                        <select id="reg-name" disabled class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <input type="password" id="reg-pass" placeholder="è¨­å®šç™»å…¥å¯†ç¢¼" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <input type="password" id="reg-pass-confirm" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼" class="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <button onclick="handleRegister()" id="reg-btn" class="w-full py-3 btn-primary rounded-lg font-bold">ç¢ºèªè¨»å†Š</button>
                    <button onclick="switchView('login')" class="w-full py-2 text-sm text-slate-400 hover:underline text-center">è¿”å›ç™»å…¥</button>
                </div>
            </div>
        </div>

        <!-- å…¬å‘Šå€è¦–åœ– (é¦–é ) -->
        <div id="view-bulletin" class="hidden-view fade-in py-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                    å…¬å‘Šèˆ‡æ•™æä¸‹è¼‰
                </h2>
                <button id="add-announcement-btn" onclick="openAnnouncementModal()" class="hidden text-sm bg-emerald-600 text-white px-4 py-2 rounded-full font-bold shadow-md hover:bg-emerald-700 transition-all">+ ç™¼å¸ƒå…¬å‘Š</button>
            </div>
            <div id="announcement-list" class="space-y-6">
                <div class="text-center py-20 text-slate-400 animate-pulse">æ­£åœ¨è¼‰å…¥é›²ç«¯å…§å®¹...</div>
            </div>
        </div>

        <!-- å€‹äººç°½åˆ°è¦–åœ– -->
        <div id="view-attendance" class="hidden-view fade-in py-6">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h2 class="text-xl font-bold mb-2">æ¯æ—¥ç°½åˆ°</h2>
                <p id="today-date" class="text-slate-500 mb-6 font-mono"></p>
                <div id="attendance-status" class="p-6 border-2 border-dashed border-slate-200 rounded-xl mb-6"><p class="text-slate-400">æ­£åœ¨æª¢æŸ¥ç‹€æ…‹...</p></div>
                <button onclick="performSignIn()" id="signin-btn" class="w-full py-4 btn-primary rounded-xl text-lg font-bold hidden">ç«‹å³ç°½åˆ°</button>
            </div>
        </div>

        <!-- æ¸¬é©—è¦–åœ– -->
        <div id="view-quiz" class="hidden-view fade-in py-6">
            <div id="quiz-init" class="glass-card rounded-2xl p-6 text-center">
                <h2 class="text-xl font-bold mb-4">åƒåŠ æ¸¬é©—</h2>
                <select id="quiz-type-select" class="w-full p-3 mb-4 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <option value="" disabled selected>è«‹é¸æ“‡æ¸¬é©—ç§‘ç›®</option>
                    <option value="è«–èª">è«–èª</option><option value="æ€§ç†">æ€§ç†</option><option value="é“å¾·ç¶“">é“å¾·ç¶“</option><option value="å…­ç¥–">å…­ç¥–</option>
                </select>
                <button onclick="startQuizFlow()" id="start-quiz-btn" class="w-full py-3 btn-primary rounded-lg font-bold">è¼‰å…¥é›²ç«¯è€ƒå·</button>
                <p class="text-[10px] text-slate-400 mt-3">* æ¸¬é©—æ™‚é–“ä»¥å°åŒ—æ¨™æº–æ™‚é–“ (GMT+8) ç‚ºæº–</p>
            </div>
            <div id="quiz-main" class="mt-4 hidden"><div id="quiz-content" class="space-y-6"></div></div>
        </div>

        <!-- æˆç¸¾è¦–åœ– -->
        <div id="view-results" class="hidden-view fade-in py-6">
            <h2 class="text-xl font-bold mb-4 text-slate-800">æ¸¬é©—æˆç¸¾è¨˜éŒ„</h2>
            <div id="history-list" class="space-y-4"></div>
        </div>

        <!-- ç®¡ç†ä¸­å¿ƒè¦–åœ– -->
        <div id="view-admin" class="hidden-view fade-in py-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-emerald-800">ç®¡ç†ä¸­å¿ƒ</h2>
                <button onclick="loadAdminDashboard()" class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">åˆ·æ–°è³‡æ–™</button>
            </div>

            <!-- ç¯©é¸å™¨é¢æ¿ -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6 space-y-3">
                <div id="admin-group-filter-container" class="hidden">
                    <label class="text-xs font-bold text-slate-400 mb-1 block px-1">é¸æ“‡æŸ¥çœ‹çµ„åˆ¥ï¼š</label>
                    <select id="admin-group-filter" onchange="applyFilters()" class="w-full p-2 border border-slate-100 rounded-lg outline-none bg-slate-50 text-sm font-bold">
                        <option value="ALL">å…¨éƒ¨çµ„åˆ¥</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-1 block px-1">ç‹€æ…‹éæ¿¾ï¼š</label>
                    <select id="admin-status-filter" onchange="applyFilters()" class="w-full p-2 border border-slate-100 rounded-lg outline-none bg-slate-50 text-sm font-bold">
                        <option value="ALL">é¡¯ç¤ºæ‰€æœ‰äººå“¡</option>
                        <option value="ABSENT" class="text-red-500">åƒ…çœ‹ç¼ºå¸­/è«‹å‡äººå“¡</option>
                    </select>
                </div>
            </div>

            <div id="attendance-report-list" class="space-y-3 mb-10"></div>
            
            <!-- æ¸¬é©—è¨­å®šå€åŸŸ (åƒ…è€å¸«/ç®¡ç†å“¡å¯è¦‹) -->
            <div id="quiz-config-container" class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-emerald-500 hidden">
                <h3 class="font-bold mb-4 text-slate-700">æ¸¬é©—é–‹æ”¾æ™‚æ®µè¨­å®š</h3>
                <button id="master-quiz-toggle" onclick="toggleMasterQuizStatus()" class="w-full py-3 rounded-xl font-bold text-white flex justify-center items-center gap-2 mb-6">
                    <span id="toggle-dot" class="w-3 h-3 rounded-full"></span><span id="toggle-text">æ­£åœ¨è®€å–...</span>
                </button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 mb-1">é–‹å§‹æ—¥æœŸæ™‚é–“</label>
                        <input type="datetime-local" id="unified-quiz-start" class="p-3 border rounded-xl outline-none bg-slate-50">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 mb-1">çµæŸæ—¥æœŸæ™‚é–“</label>
                        <input type="datetime-local" id="unified-quiz-end" class="p-3 border rounded-xl outline-none bg-slate-50">
                    </div>
                </div>
                <button onclick="saveUnifiedQuizSettings()" id="quiz-save-btn" class="w-full py-4 btn-primary rounded-xl font-bold shadow-lg">å„²å­˜é›²ç«¯è¨­å®š</button>
            </div>
        </div>

    </main>

    <!-- å„ç¨®å½ˆçª—å…§å®¹ -->
    <div id="announcement-modal" class="modal" onclick="closeAnnouncementModal()">
        <div class="modal-content !max-w-xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="ann-modal-title" class="text-xl font-bold text-slate-800">å…¬å‘Šæ•™æç·¨è¼¯</h3>
                <button onclick="closeAnnouncementModal()" class="text-slate-400 hover:text-slate-600 p-2 text-xl transition-transform active:scale-90">âœ•</button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="ann-id">
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-2 block">å…¬å‘Šæ¨™é¡Œ</label>
                    <input type="text" id="ann-title" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 mb-2 block">é‡é»å…§å®¹</label>
                    <textarea id="ann-content" class="w-full p-3 border border-slate-200 rounded-xl h-32 focus:ring-2 focus:ring-emerald-500 outline-none shadow-inner"></textarea>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-slate-400">æ•™æé€£çµæˆ–é™„ä»¶åˆ—è¡¨</label>
                        <button onclick="addResourceRow()" class="text-xs text-emerald-600 font-bold hover:underline">+ æ–°å¢</button>
                    </div>
                    <div id="ann-resources-container" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
                </div>
                <button id="ann-submit-btn" onclick="submitAnnouncement()" class="w-full py-4 btn-primary rounded-xl font-bold shadow-lg">ç¢ºèªä¸¦ç™¼å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- éš±è—æª”æ¡ˆé¸å–å™¨ -->
    <input type="file" id="global-file-picker" class="hidden" onchange="processFileSelection(event)">

    <!-- ä»£ç°½å½ˆçª— -->
    <div id="proxy-sign-modal" class="modal" onclick="closeProxyModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 class="text-xl font-bold">å‡ºå¸­ç‹€æ…‹èª¿æ•´</h3><button onclick="closeProxyModal()" class="p-2">âœ•</button></div>
            <div class="space-y-4">
                <p id="proxy-target-name" class="font-bold text-emerald-600"></p>
                <select id="proxy-leave-type" class="w-full p-3 border rounded-xl font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                    <option value="æ­£å¸¸å‡ºå¸­">æ­£å¸¸å‡ºå¸­</option><option value="æ™šåˆ°">æ™šåˆ°</option><option value="å…¬å‡">å…¬å‡</option><option value="äº‹å‡">äº‹å‡</option><option value="ç—…å‡">ç—…å‡</option>
                </select>
                <textarea id="proxy-reason-input" class="w-full p-3 border rounded-xl h-24 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="èª¿æ•´åŸå› æˆ–å‚™è¨»..."></textarea>
                <button id="proxy-submit-btn" onclick="submitProxySignIn()" class="w-full py-4 btn-primary rounded-xl font-bold">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal" onclick="closeDetailModal()"><div class="modal-content"><div id="detail-body"></div></div></div>

    <div id="message-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-2xl text-white z-[3000] fade-in hidden pointer-events-none"></div>

    <nav id="main-nav" class="nav-bar hidden">
        <div class="nav-item active" onclick="switchView('bulletin')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2v4a2 2 0 002 2h4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h3m-3 4h10m-10 4h10"></path></svg><span>å…¬å‘Š</span></div>
        <div class="nav-item" onclick="switchView('attendance')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>ç°½åˆ°</span></div>
        <div class="nav-item" onclick="switchView('quiz')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>æ¸¬é©—</span></div>
        <div class="nav-item" onclick="switchView('results')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 01-2-2V4a2 2 0 012-2h6a2 2 0 012 2v2M7 19h10m0 0a2 2 0 002-2v-3.586a1 1 0 01.293-.707l3.586-3.586a1 1 0 000-1.414l-3.586-3.586a1 1 0 01-.293-.707V5a2 2 0 00-2-2h-6"></path></svg><span>æˆç¸¾</span></div>
        <div id="nav-admin" class="nav-item hidden" onclick="switchView('admin')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><span>ç®¡ç†</span></div>
    </nav>

    <script>
        const SPREADSHEET_ID = '1u3D7u5hn7dcVGgGxmNBm233B_sz16kPuUcncvCnNr6U';
        const TEAMS_GID = '1026036029';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwKNInoCvX_qEPoQ1moVu_v9nxbEbR0ZcOQP-yu-9UvvLMLDvFKtx9q3Uxgd6vLT1Pxow/exec';
        const GROUP_ORDER = ['ç¬¬ä¸€çµ„', 'ç¬¬äºŒçµ„', 'ç¬¬ä¸‰çµ„', 'ç¬¬å››çµ„', 'ç¬¬äº”çµ„', 'ç¬¬å…­çµ„', 'ç¬¬ä¸ƒçµ„', 'å¾·åœ‹', 'å­Ÿä¿æ‹‰', 'å°å°¼', 'é¦¬ä¾†', 'ç¥å·', 'ä¸»é ˜ç­', 'ç‰¹åŠ©'];
        const QUIZ_GIDS = { 'éš¨å ‚': '0', 'è«–èª': '1250135497', 'æ€§ç†': '1342680959', 'é“å¾·ç¶“': '1246480043', 'å…­ç¥–': '1302889740' };

        let currentUser = null, teamsData = {}, quizData = [], historyData = [], proxyTarget = null, cachedSignedUsers = [], cachedAnnouncements = [], currentQuizOpenStatus = false, activeRowForUpload = null;

        // --- å…¨åŸŸæ ¸å¿ƒè¼”åŠ©å‡½å¼ ---

        function logout() { 
            localStorage.removeItem('sh_user_secure'); 
            window.location.reload(); 
        }

        function toast(m, isErr = false) { 
            const b = document.getElementById('message-box'); if (!b) return;
            b.innerText = m; b.className = `fixed top-5 right-5 p-4 rounded-lg shadow-2xl text-white z-[3000] font-bold ${isErr?'bg-red-500':'bg-emerald-600'} pointer-events-none`; 
            b.style.display = 'block'; setTimeout(() => { if (b) b.style.display = 'none'; }, 5000); 
        }

        function updateDateDisplay() { 
            const el = document.getElementById('today-date'); 
            if(el) el.innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); 
        }

        function switchView(viewName) {
            const views = document.querySelectorAll('[id^="view-"]');
            views.forEach(v => v.classList.add('hidden-view'));
            const target = document.getElementById(`view-${viewName}`); 
            if (target) target.classList.remove('hidden-view');
            const navItems = document.querySelectorAll('.nav-item'); navItems.forEach(i => i.classList.remove('active'));
            if(viewName==='bulletin') { navItems[0]?.classList.add('active'); loadAnnouncements(); }
            if(viewName==='attendance') { navItems[1]?.classList.add('active'); if(currentUser) checkAttendance(); }
            if(viewName==='quiz') navItems[2]?.classList.add('active');
            if(viewName==='results') { navItems[3]?.classList.add('active'); loadHistoryData(); }
            if(viewName==='admin') { navItems[navItems.length-1]?.classList.add('active'); loadAdminDashboard(); }
            window.scrollTo(0,0);
        }

        function initApp() {
            const saved = localStorage.getItem('sh_user_secure');
            if (saved) { try { currentUser = JSON.parse(saved); showDashboard(); } catch(e) { switchView('login'); } } 
            else { switchView('login'); }
        }

        function showDashboard() {
            const nav = document.getElementById('main-nav'), userDisplay = document.getElementById('user-display'), displayName = document.getElementById('display-name'), rb = document.getElementById('display-role'), navAdmin = document.getElementById('nav-admin'), quizCfg = document.getElementById('quiz-config-container'), addAnnBtn = document.getElementById('add-announcement-btn');
            if (nav) nav.classList.remove('hidden'); if (userDisplay) userDisplay.classList.remove('hidden'); if (displayName) displayName.innerText = `${currentUser.group} - ${currentUser.name}`;
            if (rb) {
                rb.innerText = currentUser.role || 'çµ„å“¡'; rb.className = 'role-badge';
                const roleName = currentUser.role || '', isAdmin = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«'].includes(roleName), isLeader = ['Leader', 'çµ„é•·'].includes(roleName);
                if (isAdmin) { rb.classList.add(roleName.includes('Admin') ? 'role-admin' : 'role-teacher'); if (navAdmin) navAdmin.classList.remove('hidden'); if (quizCfg) quizCfg.classList.remove('hidden'); if (addAnnBtn) addAnnBtn.classList.remove('hidden'); }
                else if (isLeader) { rb.classList.add('role-leader'); if (navAdmin) navAdmin.classList.remove('hidden'); } else { rb.classList.add('role-user'); }
            }
            switchView('bulletin');
        }

        // --- åœ–ç‰‡åµæ¸¬é‚è¼¯è¼”åŠ© ---

        function isImageUrl(url) {
            if (!url) return false;
            const imgExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
            const lowerUrl = url.toLowerCase();
            return imgExts.some(ext => lowerUrl.includes('.' + ext)) || 
                   url.includes('drive.google.com/uc') || 
                   url.includes('drive.google.com/file/d/');
        }

        function convertToDirectLink(url) {
            if (!url) return "";
            if (url.includes('drive.google.com/file/d/')) {
                const id = url.split('/d/')[1].split('/')[0];
                return `https://drive.google.com/uc?id=${id}`;
            }
            return url;
        }

        // --- æ¸¬é©—ç³»çµ±æŠ“å–èˆ‡è§£æ (æ”¹ç‚ºå¾å°ˆå±¬æ¬„ä½è®€å–åœ–ç‰‡) ---

        async function startQuizFlow() {
            const type = document.getElementById('quiz-type-select')?.value; 
            if (!type) return toast('è«‹å…ˆé¸æ“‡è¦æ¸¬é©—çš„ç§‘ç›®', true);
            
            const btn = document.getElementById('start-quiz-btn'); 
            if(btn) { btn.disabled = true; btn.innerText = "é©—è­‰æ™‚æ•ˆä¸­..."; }

            try {
                const resConfig = await fetch(`${APPS_SCRIPT_URL}?action=getConfig`);
                const config = await resConfig.json(); 
                const quizConf = config['éš¨å ‚']; 
                const now = new Date();

                if (quizConf?.start && quizConf?.end) {
                    const startTime = parseToTaipeiDate(quizConf.start);
                    const endTime = parseToTaipeiDate(quizConf.end);
                    if (now < startTime) { toast(`å°šæœªé–‹æ”¾ã€‚é è¨ˆï¼š${startTime.toLocaleString()}`, true); return; }
                    if (now > endTime) { toast('æ¸¬é©—æ™‚é–“å·²é', true); return; }
                }

                document.getElementById('quiz-init').classList.add('hidden');
                document.getElementById('quiz-main').classList.remove('hidden');
                document.getElementById('quiz-content').innerHTML = '<p class="text-center py-10">æ­£åœ¨æº–å‚™é›²ç«¯è€ƒå·...</p>';

                const [q1, q2] = await Promise.all([
                    fetchSingleSheet(QUIZ_GIDS['éš¨å ‚']), 
                    fetchSingleSheet(QUIZ_GIDS[type])
                ]);
                
                quizData = [...q1, ...q2];
                renderQuiz();
            } catch (e) {
                toast('ç³»çµ±é€£ç·šç•°å¸¸', true);
            } finally {
                if(btn) btn.disabled = false;
            }
        }

        async function fetchSingleSheet(gid) {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`);
                const text = await res.text();
                const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!match) return [];
                const data = JSON.parse(match[1]);
                return data.table.rows.map(r => {
                    if (!r.c[0]?.v) return null;
                    return {
                        question: r.c[0]?.v,
                        type: r.c[1]?.v?.toLowerCase().trim() || 'single',
                        options: r.c[2]?.v ? String(r.c[2].v).split(',').map(s=>s.trim()) : [],
                        answer: String(r.c[3]?.v||'').split(',').map(s=>s.trim()),
                        score: parseFloat(r.c[4]?.v||0),
                        photo: r.c[5]?.v || '' // æ–°å¢ï¼šå¾è©¦ç®—è¡¨ç¬¬ 6 æ¬„è®€å–ç…§ç‰‡ç¶²å€
                    };
                }).filter(q => q !== null);
            } catch(e) { return []; }
        }

        function renderQuiz() {
            const content = document.getElementById('quiz-content'); if(!content) return;
            let h = `<div class="bg-emerald-50 p-3 rounded-xl mb-4 text-emerald-800 text-xs font-bold text-center border">æ­£å¼æ¸¬é©—ä¸­</div>`;
            quizData.forEach((q, i) => {
                const qId = `q${i+1}`; 
                
                // æ”¹é€²ï¼šç›´æ¥å¾ q.photo æ¬„ä½ç”Ÿæˆåœ–ç‰‡ HTMLï¼Œä¸å†æœå°‹é¡Œç›®æ–‡å­—
                let imgHtml = "";
                if (q.photo && isImageUrl(q.photo)) {
                    imgHtml = `<img src="${convertToDirectLink(q.photo)}" class="quiz-image" onclick="window.open('${q.photo}', '_blank')">`;
                }

                let opts = '';
                if(q.type !== 'fill') { 
                    opts = [...q.options].sort(()=>Math.random()-0.5).map(o => `<label class="hover:bg-slate-50 border p-3 rounded-xl flex items-center mb-2 cursor-pointer transition-all active:scale-95"><input type="${q.type==='single'?'radio':'checkbox'}" name="${qId}" value="${o}" class="mr-3 w-5 h-5 text-emerald-600 focus:ring-emerald-500"><span class="text-slate-700 text-sm font-medium">${o}</span></label>`).join(''); 
                } else {
                    opts = `<input type="text" class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none shadow-inner bg-slate-50" id="${qId}-input" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ...">`;
                }
                
                h += `<div class="question-card p-6 rounded-2xl shadow-sm mb-6 bg-white border border-slate-100" id="${qId}">
                    <h3 class="font-bold mb-2 text-slate-800 text-base leading-relaxed">${i+1}. ${q.question}</h3>
                    ${imgHtml}
                    <div class="options mt-4">${opts}</div>
                </div>`;
            });
            h += `<button onclick="handleQuizSubmit()" id="quiz-final-btn" class="w-full py-4 btn-primary rounded-2xl font-bold text-lg mb-10 shadow-xl active:scale-95 transition-all">äº¤å·ä¸¦é€€å‡º</button>`;
            content.innerHTML = h; window.scrollTo(0,0);
        }

        // --- ç®¡ç†é‚è¼¯ ---

        async function loadAdminDashboard() {
            loadAttendanceReport();
            const isAdmin = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«'].includes(currentUser?.role || '');
            if (isAdmin) loadQuizConfigs();
        }

        async function loadAttendanceReport() {
            const list = document.getElementById('attendance-report-list'); if (!list) return;
            list.innerHTML = '<div class="text-center py-10 font-mono text-slate-400 animate-pulse">SYNCING...</div>';
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getAttendanceReport&role=${encodeURIComponent(currentUser.role)}&group=${encodeURIComponent(currentUser.group)}`);
                const result = await res.json(); cachedSignedUsers = result.data || [];
                const isAdmin = ['Admin','Teacher','è€å¸«','ç®¡ç†å“¡'].includes(currentUser.role), fs = document.getElementById('admin-group-filter'), container = document.getElementById('admin-group-filter-container');
                if (isAdmin) { if (container) container.classList.remove('hidden'); if (fs && fs.options.length <= 1) { fs.innerHTML = '<option value="ALL">å…¨éƒ¨çµ„åˆ¥</option>'; sortGroupsByCustomOrder(Object.keys(teamsData)).forEach(g => fs.add(new Option(g, g))); } }
                else { if (container) container.classList.add('hidden'); }
                applyFilters();
            } catch (e) { list.innerHTML = '<div class="text-center py-10 text-red-400">å¤±æ•—</div>'; }
        }

        function applyFilters() {
            const isAdmin = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«'].includes(currentUser?.role || '');
            let gVal = document.getElementById('admin-group-filter')?.value || 'ALL';
            if (!isAdmin) gVal = currentUser.group;
            const statusFilter = document.getElementById('admin-status-filter')?.value || 'ALL', list = document.getElementById('attendance-report-list');
            if (!list) return;
            let html = '', groups = gVal === 'ALL' ? sortGroupsByCustomOrder(Object.keys(teamsData)) : [gVal];
            groups.forEach(gn => {
                let gHtml = '', matchCount = 0;
                (teamsData[gn] || []).forEach(name => {
                    const sign = cachedSignedUsers.find(s => s.group === gn && s.name === name);
                    if(statusFilter === 'ABSENT' && sign && !sign.note.includes('å‡')) return;
                    matchCount++;
                    let dot = 'dot-missing', color = 'text-red-400', right = 'æœªç°½åˆ°', reason = '';
                    if(sign) {
                        const parts = sign.note.split(' '); const type = parts[0]; reason = parts.slice(1).join(' ');
                        if(type.includes('å‡')) { dot = 'dot-leave'; color = 'text-orange-500'; right = type; }
                        else if(type.includes('æ™šåˆ°')) { dot = 'dot-late'; color = 'text-yellow-600'; right = `æ™šåˆ° (${sign.time})`; }
                        else { dot = 'dot-signed'; color = 'text-emerald-500'; right = `å‡ºå¸­ (${sign.time})`; }
                    }
                    gHtml += `<div class="bg-white p-4 rounded-xl shadow-sm border mb-2 flex justify-between items-center"><div class="flex items-center"><span class="status-dot ${dot}"></span><div class="flex flex-col"><span class="font-bold text-sm text-slate-700">${name}</span>${reason?`<span class="text-[10px] text-slate-400">${reason}</span>`:''}</div></div><div class="flex items-center gap-3"><span class="text-xs font-bold ${color}">${right}</span><button onclick="openProxyModal('${gn}', '${name}')" class="text-[10px] px-2 py-1 border rounded active:bg-slate-100">èª¿æ•´</button></div></div>`;
                });
                if(matchCount > 0) html += `<div class="mt-4 mb-2 px-2 text-xs font-bold text-slate-400 flex justify-between"><span>${gn}</span><span>${matchCount}äºº</span></div>` + gHtml;
            });
            list.innerHTML = html || '<div class="text-center py-10">æŸ¥ç„¡è³‡æ–™</div>';
        }

        // --- å‰©é¤˜è¼”åŠ©å‡½å¼ç¶­æŒåŸæ¨£ ---
        async function fetchTeamsData() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${TEAMS_GID}&t=${Date.now()}`);
                const text = await res.text();
                const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                const data = JSON.parse(match[1]);
                teamsData = {}; 
                data.table.rows.forEach(r => { const g = r.c[0]?.v, n = r.c[1]?.v; if(g && n && g!=='çµ„åˆ¥') { if(!teamsData[g]) teamsData[g]=[]; teamsData[g].push(n); } });
                const sortedGroups = sortGroupsByCustomOrder(Object.keys(teamsData));
                [document.getElementById('login-group'), document.getElementById('reg-group')].forEach(s => { 
                    if(!s) return; s.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡çµ„åˆ¥</option>'; sortedGroups.forEach(g => s.add(new Option(g, g))); 
                    s.onchange = (e) => { const ns = e.target.id==='login-group'?document.getElementById('login-name'):document.getElementById('reg-name'); if(!ns) return; ns.innerHTML = '<option value="" disabled selected>é¸æ“‡å§“å</option>'; (teamsData[e.target.value] || []).sort().forEach(n => ns.add(new Option(n, n))); ns.disabled = false; }; 
                });
            } catch (e) { toast('åå–®è®€å–å¤±æ•—', true); }
        }

        async function loadAnnouncements() {
            const list = document.getElementById('announcement-list'); if (!list) return;
            list.innerHTML = '<div class="text-center py-20 text-slate-400">æ­£åœ¨è®€å–...</div>';
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getAnnouncements`), data = await res.json();
                cachedAnnouncements = data.data || []; renderAnnouncements();
            } catch (e) { list.innerHTML = '<div class="text-center py-20">é€£ç·šå¤±æ•—</div>'; }
        }

        function renderAnnouncements() {
            const list = document.getElementById('announcement-list'); if (!list) return;
            if (!cachedAnnouncements.length) { list.innerHTML = '<div class="text-center py-20">ç„¡å…§å®¹</div>'; return; }
            const isAdmin = ['Admin', 'ç®¡ç†å“¡', 'Teacher', 'è€å¸«'].includes(currentUser?.role || '');
            list.innerHTML = cachedAnnouncements.map((ann, idx) => {
                let res = []; try { res = JSON.parse(ann.link || '[]'); } catch(e) { if(ann.link) res = [{label:'ä¸‹è¼‰è³‡æ–™', url:ann.link}]; }
                return `<div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative group fade-in mb-6">${isAdmin?`<button onclick="openAnnouncementModal(${idx})" class="absolute top-4 right-4 text-xs text-emerald-600 font-bold opacity-0 group-hover:opacity-100 transition-all">ç·¨è¼¯</button>`:''}<div class="text-[10px] font-mono text-emerald-600 font-bold mb-1 uppercase">${ann.time || ''}</div><h3 class="text-lg font-black text-slate-800 mb-2">${ann.title}</h3><div class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap mb-4">${ann.content}</div>${res.length?`<div class="pt-4 border-t border-slate-50 flex flex-wrap gap-2">${res.map(r=>`<a href="${r.url}" target="_blank" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-2 rounded-lg font-bold flex items-center gap-1 hover:bg-emerald-600 hover:text-white border border-emerald-100 transition-all">ğŸ”— ${r.label}</a>`).join('')}</div>`:''}</div>`;
            }).join('');
        }

        function handleLogin() {
            const g = document.getElementById('login-group')?.value, n = document.getElementById('login-name')?.value, p = document.getElementById('login-pass')?.value;
            if(!g || !n || !p) return toast('å®Œæ•´è¼¸å…¥', true);
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', group: g, name: n, password: p }), redirect: 'follow' })
                .then(r => r.json()).then(r => { if(r.success) { currentUser = { group: r.group, name: r.name, role: r.role }; localStorage.setItem('sh_user_secure', JSON.stringify(currentUser)); showDashboard(); } else toast(r.error, true); })
                .catch(() => toast('é€£ç·šç•°å¸¸', true));
        }

        async function handleQuizSubmit() { const btn = document.getElementById('quiz-final-btn'); if(btn) { btn.disabled = true; btn.innerText = 'æäº¤ä¸­...'; } const answers = quizData.map((q, i) => { const el = document.getElementById(`q${i+1}`); let val = 'æœªä½œç­”'; if(q.type === 'single') val = el.querySelector('input:checked')?.value || 'æœªä½œç­”'; else if(q.type === 'multiple') val = Array.from(el.querySelectorAll('input:checked')).map(i => i.value).sort().join(', ') || 'æœªä½œç­”'; else val = document.getElementById(`q${i+1}-input`)?.value.trim() || 'æœªä½œç­”'; return { qId: `q${i+1}`, userAnswer: val }; }); try { const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'submitQuiz', group: currentUser.group, name: currentUser.name, quizType: document.getElementById('quiz-type-select').value, userAnswersJson: JSON.stringify(answers), quizDataJson: JSON.stringify(quizData) }) }); if ((await res.json()).status === 'success') { toast('æäº¤æˆåŠŸ'); switchView('results'); } } catch (e) { toast('å¤±æ•—', true); if(btn) btn.disabled = false; } }
        async function handleRegister() { const g = document.getElementById('reg-group')?.value, n = document.getElementById('reg-name')?.value, p = document.getElementById('reg-pass')?.value, c = document.getElementById('reg-pass-confirm')?.value; if(!g || !n || !p) return toast('è³‡è¨Šä¸å…¨', true); if(p!==c) return toast('ä¸ä¸€è‡´', true); try { const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'register', group:g, name:n, password:p}) }); if((await res.json()).success) { toast('æˆåŠŸï¼è«‹ç™»å…¥'); switchView('login'); } } catch (e) { toast('å¤±æ•—', true); } }
        async function checkAttendance() { try { const res = await fetch(`${APPS_SCRIPT_URL}?action=checkAttendance&group=${encodeURIComponent(currentUser.group)}&name=${encodeURIComponent(currentUser.name)}`), r = await res.json(), div = document.getElementById('attendance-status'), btn = document.getElementById('signin-btn'); if (r.signedIn) { if(div) div.innerHTML = `<p class="text-emerald-600 font-bold">âœ… å·²å®Œæˆç°½åˆ°<br><span class="text-xs text-slate-400">${r.time}</span></p>`; btn?.classList.add('hidden'); } else { if(div) div.innerHTML = `<p class="text-slate-400">å°šæœªç°½åˆ°</p>`; btn?.classList.remove('hidden'); } } catch (e) {} }
        async function performSignIn() { try { const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'signIn', group: currentUser.group, name: currentUser.name, leaveType: 'æ­£å¸¸å‡ºå¸­', reason: 'è‡ªä¸»ç°½åˆ°' }) }); if((await res.json()).success) { toast('ç°½åˆ°æˆåŠŸ'); checkAttendance(); } } catch (e) { toast('å¤±æ•—', true); } }
        async function loadHistoryData() { const list = document.getElementById('history-list'); if(!list) return; list.innerHTML = '<div class="text-center py-10">è¼‰å…¥æˆç¸¾ä¸­...</div>'; try { const res = await fetch(`${APPS_SCRIPT_URL}?action=getHistory&name=${encodeURIComponent(currentUser.name)}&group=${encodeURIComponent(currentUser.group)}`), r = await res.json(); if (r.success && r.data.length) { historyData = r.data; list.innerHTML = r.data.map((r, i) => `<div class="bg-white p-5 rounded-2xl shadow-sm border flex justify-between items-center cursor-pointer hover:border-emerald-300 transition-all" onclick="showExamDetail(${i})"><div><div class="text-[10px] text-slate-400 font-mono">${r.timestamp}</div><div class="font-bold">${r.quizType}</div></div><div class="text-3xl font-black text-emerald-500">${r.score}</div></div>`).join(''); } else list.innerHTML = '<div class="text-center py-10">ç„¡ç´€éŒ„</div>'; } catch (e) {} }
        function showExamDetail(i) { const r = historyData[i], d = JSON.parse(r.details), title = document.getElementById('detail-title'), body = document.getElementById('detail-body'); if(title) title.innerText = r.quizType; if(body) body.innerHTML = d.map((q, idx) => `<div class="p-4 border rounded-xl mb-2"><div class="font-bold text-sm text-slate-700">${idx+1}. ${q.question} ${q.isCorrect?'âœ…':'âŒ'}</div><div class="text-xs mt-1">å›ç­”ï¼š${q.userAnswer} ${!q.isCorrect?' / æ­£ç¢ºï¼š'+q.correctAnswer:''}</div></div>`).join(''); const modal = document.getElementById('detail-modal'); if(modal) modal.style.display = 'flex'; }
        function openProxyModal(g, n) { proxyTarget = {g, n}; const el = document.getElementById('proxy-target-name'); if(el) el.innerText = `${g} - ${n}`; const type = document.getElementById('proxy-leave-type'), reason = document.getElementById('proxy-reason-input'); if(type) type.value = 'æ­£å¸¸å‡ºå¸­'; if(reason) reason.value = ''; const modal = document.getElementById('proxy-sign-modal'); if(modal) modal.style.display = 'flex'; }
        async function submitProxySignIn() { const btn = document.getElementById('proxy-submit-btn'); if(btn) btn.disabled = true; try { const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'signIn', group: proxyTarget.g, name: proxyTarget.n, leaveType: document.getElementById('proxy-leave-type').value, reason: document.getElementById('proxy-reason-input').value.trim() }) }); if((await res.json()).success) { toast('ç‹€æ…‹æ›´æ–°æˆåŠŸ'); closeProxyModal(); loadAttendanceReport(); } } catch (e) { toast('å¤±æ•—', true); } finally { if(btn) btn.disabled = false; } }
        async function loadQuizConfigs() { try { const res = await fetch(`${APPS_SCRIPT_URL}?action=getConfig`), config = await res.json(), sConf = config['éš¨å ‚'] || { start: '', end: '' }, now = new Date(), start = parseToTaipeiDate(sConf.start), end = parseToTaipeiDate(sConf.end); const startEl = document.getElementById('unified-quiz-start'), endEl = document.getElementById('unified-quiz-end'); if(startEl) startEl.value = start ? new Date(start.getTime() - start.getTimezoneOffset() * 60000).toISOString().slice(0, 16) : ""; if(endEl) endEl.value = end ? new Date(end.getTime() - end.getTimezoneOffset() * 60000).toISOString().slice(0, 16) : ""; const toggleBtn = document.getElementById('master-quiz-toggle'), tb = document.getElementById('toggle-text'), td = document.getElementById('toggle-dot'); if (start && end && now >= start && now <= end) { currentQuizOpenStatus = true; if(toggleBtn) toggleBtn.className = "w-full py-3 rounded-xl font-bold bg-emerald-600 text-white flex justify-center items-center gap-2"; if(tb) tb.innerText = "æ¸¬é©—é€²è¡Œä¸­ (é»æ“Šé—œé–‰)"; if(td) td.className = "w-3 h-3 rounded-full bg-white animate-pulse"; } else { currentQuizOpenStatus = false; if(toggleBtn) toggleBtn.className = "w-full py-3 rounded-xl font-bold bg-rose-600 text-white flex justify-center items-center gap-2"; if(tb) tb.innerText = "æ¸¬é©—å·²é—œé–‰ (é»æ“Šé–‹æ”¾)"; if(td) td.className = "w-3 h-3 rounded-full bg-white"; } } catch (e) {} }
        async function toggleMasterQuizStatus() { const btn = document.getElementById('master-quiz-toggle'); if(btn) btn.disabled = true; try { const now = new Date(), format = (d) => `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; let start = format(now), end = currentQuizOpenStatus ? start : format(new Date(now.getTime() + 2*60*60*1000)); const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateConfig', config: JSON.stringify({ 'éš¨å ‚':{start,end},'è«–èª':{start,end},'æ€§ç†':{start,end},'é“å¾·ç¶“':{start,end},'å…­ç¥–':{start,end} }) }) }); if ((await res.json()).success) toast('ç‹€æ…‹æˆåŠŸåˆ‡æ›'); } catch (e) { toast('é€£ç·šå¤±æ•—', true); } finally { loadQuizConfigs(); } }
        async function saveUnifiedQuizSettings() { const s = document.getElementById('unified-quiz-start')?.value?.replace('T', ' '), e = document.getElementById('unified-quiz-end')?.value?.replace('T', ' '); if(!s || !e) return toast('è«‹è¼¸å…¥é–‹å§‹èˆ‡çµæŸæ™‚é–“', true); try { const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateConfig', config: JSON.stringify({ 'éš¨å ‚':{start:s,end:e},'è«–èª':{start:s,end:e},'æ€§ç†':{start:s,end:e},'é“å¾·ç¶“':{start:s,end:e},'å…­ç¥–':{start:s,end:e} }) }) }); if((await res.json()).success) toast('é›²ç«¯è¨­å®šå·²å„²å­˜'); } catch (e) { toast('å¤±æ•—', true); } finally { loadQuizConfigs(); } }
        function openAnnouncementModal(idx = null) { const modal = document.getElementById('announcement-modal'), container = document.getElementById('ann-resources-container'); if(!modal || !container) return; container.innerHTML = ''; if (idx !== null) { const d = cachedAnnouncements[idx]; document.getElementById('ann-modal-title').innerText = "ç·¨è¼¯å…¬å‘Šå…§å®¹"; document.getElementById('ann-id').value = d.id; document.getElementById('ann-title').value = d.title; document.getElementById('ann-content').value = d.content; let res = []; try { res = JSON.parse(d.link || '[]'); } catch(e) { if(d.link) res = [{label:'ä¸‹è¼‰è³‡æ–™', url:d.link}]; } res.forEach(r => addResourceRow(r.label, r.url)); } else { document.getElementById('ann-modal-title').innerText = "ç™¼å¸ƒæ–°å…¬å‘Š"; document.getElementById('ann-id').value = ""; document.getElementById('ann-title').value = ""; document.getElementById('ann-content').value = ""; addResourceRow('ä½œæ¥­è¡¨å–®', ''); } modal.style.display = 'flex'; }
        function parseToTaipeiDate(val) { if (!val) return null; if (typeof val === 'string' && val.endsWith('Z')) return new Date(val); const cleanVal = val.toString().replace(/\//g, '-').replace(' ', 'T'); return new Date(cleanVal + (cleanVal.includes('+') ? '' : '+08:00')); }
        function sortGroupsByCustomOrder(arr) { return arr.sort((a, b) => { const ia = GROUP_ORDER.indexOf(a), ib = GROUP_ORDER.indexOf(b); if (ia !== -1 && ib !== -1) return ia - ib; if (ia !== -1) return -1; if (ib !== -1) return 1; return a.localeCompare(b, 'zh-Hant'); }); }

        // --- å•Ÿå‹•åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDateDisplay();
            fetchTeamsData();
            initApp();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>崇華十六期整合管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', '標楷體', sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            margin: 0;
            padding-bottom: 80px; 
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active { color: #10b981; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        .btn-primary {
            background-color: #10b981;
            color: white;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        .btn-primary:hover:not(:disabled) { background-color: #059669; transform: translateY(-1px); }
        .btn-primary:active:not(:disabled) { transform: translateY(1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .question-card { border-left: 4px solid #10b981; background: white; }
        .options label {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #timer-bar { position: sticky; top: 0; z-index: 40; background: #ecfdf5; color: #065f46; border-bottom: 1px solid #a7f3d0; }
        .hidden-view { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 詳解彈窗樣式 */
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 20px;
            overflow-y: auto;
            padding: 24px;
        }
    </style>
</head>
<body>

    <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold text-emerald-600">崇華十六期管理系統</h1>
        <div id="user-display" class="text-sm font-medium text-slate-600 hidden">
            <span id="display-name">載入中...</span>
            <button onclick="logout()" class="ml-2 text-red-500 hover:underline">登出</button>
        </div>
    </header>

    <main class="container mx-auto max-w-2xl p-4">

        <!-- 登入介面 -->
        <div id="view-login" class="fade-in py-10">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">學員登入</h2>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400">組別</label>
                        <select id="login-group" class="w-full p-3 rounded-lg border border-slate-200 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">姓名</label>
                        <select id="login-name" disabled class="w-full p-3 rounded-lg border border-slate-200 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">密碼</label>
                        <input type="password" id="login-pass" class="w-full p-3 rounded-lg border border-slate-200 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <button onclick="handleLogin()" id="login-btn" class="w-full py-3 btn-primary rounded-lg font-bold">進入系統</button>
                    <div class="text-center mt-6 pt-4 border-t border-slate-100">
                        <button onclick="switchView('register')" class="text-sm text-emerald-600 font-bold hover:underline">初次使用？註冊設定密碼</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 註冊介面 -->
        <div id="view-register" class="hidden-view fade-in py-10">
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">帳號註冊</h2>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-slate-400">選擇您的組別</label>
                        <select id="reg-group" class="w-full p-3 rounded-lg border border-slate-200 mt-1"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">選擇您的姓名</label>
                        <select id="reg-name" disabled class="w-full p-3 rounded-lg border border-slate-200 mt-1"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">設定登入密碼</label>
                        <input type="password" id="reg-pass" placeholder="6 位數以上密碼" class="w-full p-3 rounded-lg border border-slate-200 mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">再次確認密碼</label>
                        <input type="password" id="reg-pass-confirm" placeholder="再次輸入密碼" class="w-full p-3 rounded-lg border border-slate-200 mt-1">
                    </div>
                    <button onclick="handleRegister()" id="reg-btn" class="w-full py-3 btn-primary rounded-lg font-bold">確認註冊並鎖定密碼</button>
                    <button onclick="switchView('login')" class="w-full py-2 text-sm text-slate-400 hover:underline mt-2 text-center">返回登入</button>
                </div>
            </div>
        </div>

        <!-- 簽到介面 -->
        <div id="view-attendance" class="hidden-view fade-in py-6">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h2 class="text-xl font-bold mb-2">每日簽到</h2>
                <p id="today-date" class="text-slate-500 mb-6 font-mono"></p>
                <div id="attendance-status" class="p-6 border-2 border-dashed border-slate-200 rounded-xl mb-6">
                    <p class="text-slate-400">正在檢查簽到狀態...</p>
                </div>
                <button onclick="performSignIn()" id="signin-btn" class="w-full py-4 btn-primary rounded-xl text-lg font-bold hidden">立即簽到</button>
            </div>
        </div>

        <!-- 測驗介面 -->
        <div id="view-quiz" class="hidden-view fade-in">
            <div id="quiz-init" class="glass-card rounded-2xl p-6 text-center">
                <h2 class="text-xl font-bold mb-4">參加測驗</h2>
                <select id="quiz-type-select" class="w-full p-3 mb-4 rounded-lg border border-slate-200">
                    <option value="" disabled selected>請選擇科目</option>
                    <option value="論語">論語</option><option value="性理">性理</option><option value="道德經">道德經</option><option value="六祖">六祖</option>
                </select>
                <button onclick="startQuizFlow()" class="w-full py-3 btn-primary rounded-lg font-bold">開始載入題目</button>
            </div>
            <div id="quiz-main" class="mt-4 hidden"><div id="quiz-content" class="space-y-6"></div></div>
        </div>

        <!-- 成績查詢介面 -->
        <div id="view-results" class="hidden-view fade-in py-6">
            <h2 class="text-xl font-bold mb-4">歷史成績查詢</h2>
            <div id="history-list" class="space-y-4"></div>
        </div>

    </main>

    <!-- 詳解彈窗 -->
    <div id="detail-modal" class="modal" onclick="closeDetailModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="detail-title" class="text-xl font-bold">考試詳解</h3>
                <button onclick="closeDetailModal()" class="text-slate-400 hover:text-slate-600">✕ 關閉</button>
            </div>
            <div id="detail-body" class="space-y-6"></div>
        </div>
    </div>

    <nav id="main-nav" class="nav-bar hidden">
        <div class="nav-item active" onclick="switchView('attendance')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span>簽到</span>
        </div>
        <div class="nav-item" onclick="switchView('quiz')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span>測驗</span>
        </div>
        <div class="nav-item" onclick="switchView('results')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 01-2-2V4a2 2 0 012-2h6a2 2 0 012 2v2M7 19h10m0 0a2 2 0 002-2v-3.586a1 1 0 01.293-.707l3.586-3.586a1 1 0 000-1.414l-3.586-3.586a1 1 0 01-.293-.707V5a2 2 0 00-2-2h-6"></path></svg>
            <span>成績</span>
        </div>
    </nav>

    <div id="message-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-2xl text-white z-[1000] hidden"></div>

    <script>
        const SPREADSHEET_ID = '1u3D7u5hn7dcVGgGxmNBm233B_sz16kPuUcncvCnNr6U';
        const TEAMS_GID = '1026036029';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxHP1X2wE9iWiwm7Spm-C_H2OTdqpxuUihc13_xNAlEHVJzOviO4Xq7Q74DTUK015GW4A/exec';
        const QUIZ_GIDS = { '隨堂': '0', '論語': '1250135497', '性理': '1342680959', '道德經': '1246480043', '六祖': '1302889740' };

        let currentUser = null; 
        let teamsData = {};
        let quizData = [];
        let historyData = [];

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            fetchTeamsData();
            updateDateDisplay();
        });

        function initApp() {
            const savedUser = localStorage.getItem('sh_user_secure');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } else { switchView('login'); }
        }

        function showDashboard() {
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('user-display').classList.remove('hidden');
            document.getElementById('display-name').innerText = `${currentUser.group} - ${currentUser.name}`;
            switchView('attendance');
            checkAttendance();
        }

        // --- 核心邏輯：註冊 ---
        async function handleRegister() {
            const group = document.getElementById('reg-group').value;
            const name = document.getElementById('reg-name').value;
            const pass = document.getElementById('reg-pass').value;
            const confirm = document.getElementById('reg-pass-confirm').value;

            if (!group || !name || !pass) return toast('請填寫完整資訊', true);
            if (pass.length < 6) return toast('密碼至少需要 6 位', true);
            if (pass !== confirm) return toast('密碼確認不一致', true);

            const btn = document.getElementById('reg-btn');
            btn.disabled = true;
            btn.innerText = '處理中...';

            try {
                const params = new URLSearchParams({ action: 'register', group, name, password: pass });
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: params });
                const result = await res.json();
                
                if (result.success || result.status === 'success') {
                    toast('註冊並設定密碼成功！');
                    switchView('login');
                } else {
                    toast(result.error || '註冊失敗', true);
                }
            } catch (e) { toast('網路錯誤', true); }
            btn.disabled = false;
            btn.innerText = '確認註冊並鎖定密碼';
        }

        // --- 核心邏輯：登入 ---
        async function handleLogin() {
            const group = document.getElementById('login-group').value;
            const name = document.getElementById('login-name').value;
            const password = document.getElementById('login-pass').value;
            if (!group || !name || !password) return toast('請輸入組別、姓名與密碼', true);
            
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.innerText = '驗證中...';
            try {
                const params = new URLSearchParams({ action: 'login', group, name, password });
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.success || result.status === 'success') {
                    currentUser = { group, name };
                    localStorage.setItem('sh_user_secure', JSON.stringify(currentUser));
                    showDashboard();
                    toast('登入成功');
                } else { toast(result.error || '密碼錯誤或尚未註冊', true); }
            } catch (e) { toast('連線失敗', true); }
            btn.disabled = false;
            btn.innerText = '進入系統';
        }

        // --- 核心邏輯：簽到 ---
        async function checkAttendance() {
            const statusDiv = document.getElementById('attendance-status');
            const btn = document.getElementById('signin-btn');
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=checkAttendance&group=${encodeURIComponent(currentUser.group)}&name=${encodeURIComponent(currentUser.name)}`);
                const result = await res.json();
                if (result.signedIn) {
                    statusDiv.innerHTML = `<p class="text-emerald-600 font-bold">✅ 今日已完成簽到<br><span class="text-xs text-slate-400 font-normal">簽到時間：${result.time}</span></p>`;
                    btn.classList.add('hidden');
                } else {
                    statusDiv.innerHTML = `<p class="text-slate-400">尚未完成今日簽到</p>`;
                    btn.classList.remove('hidden');
                }
            } catch (e) { statusDiv.innerHTML = `<p class="text-red-400 text-sm">檢查簽到狀態失敗</p>`; }
        }

        async function performSignIn() {
            const btn = document.getElementById('signin-btn');
            btn.disabled = true;
            try {
                const params = new URLSearchParams({ action: 'signIn', group: currentUser.group, name: currentUser.name });
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.success || result.status === 'success') {
                    toast('簽到成功');
                    checkAttendance();
                } else { toast(result.error || '簽到失敗', true); btn.disabled = false; }
            } catch (e) { toast('連線失敗', true); btn.disabled = false; }
        }

        // --- 其他輔助函式 ---
        function switchView(viewName) {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden-view'));
            const target = document.getElementById(`view-${viewName}`);
            if (target) target.classList.remove('hidden-view');
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            if (viewName === 'attendance') navItems[0]?.classList.add('active');
            if (viewName === 'quiz') navItems[1]?.classList.add('active');
            if (viewName === 'results') navItems[2]?.classList.add('active');
            
            if (viewName === 'results') loadHistoryData();
            if (viewName === 'attendance' && currentUser) checkAttendance();
        }

        async function fetchTeamsData() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${TEAMS_GID}`;
                const res = await fetch(url);
                const data = JSON.parse((await res.text()).match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/)[1]);
                teamsData = {};
                data.table.rows.forEach(row => {
                    const g = row.c[0]?.v; const n = row.c[1]?.v;
                    if (g && n && g !== '組別') { if (!teamsData[g]) teamsData[g] = []; teamsData[g].push(n); }
                });
                [document.getElementById('login-group'), document.getElementById('reg-group')].forEach(select => {
                    select.innerHTML = '<option value="" disabled selected>請選擇組別</option>';
                    Object.keys(teamsData).forEach(g => { const opt = document.createElement('option'); opt.value = opt.text = g; select.appendChild(opt); });
                    select.onchange = (e) => {
                        const ns = e.target.id === 'login-group' ? document.getElementById('login-name') : document.getElementById('reg-name');
                        ns.innerHTML = '<option value="" disabled selected>選擇姓名</option>';
                        teamsData[e.target.value].forEach(n => { const opt = document.createElement('option'); opt.value = opt.text = n; ns.appendChild(opt); });
                        ns.disabled = false;
                    };
                });
            } catch (e) { console.error('名單獲取失敗', e); }
        }

        async function loadHistoryData() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="text-center py-10 text-slate-400">載入中...</div>';
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=getHistory&name=${encodeURIComponent(currentUser.name)}&group=${encodeURIComponent(currentUser.group)}`);
                const result = await res.json();
                if ((result.success || result.status === 'success') && result.data && result.data.length > 0) {
                    historyData = result.data;
                    list.innerHTML = result.data.map((r, index) => `
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer hover:border-emerald-300 transition-all fade-in" onclick="showExamDetail(${index})">
                            <div>
                                <div class="text-xs text-slate-400">${r.timestamp}</div>
                                <div class="font-bold text-slate-700">${r.quizType}</div>
                                <div class="text-[10px] text-emerald-600 mt-1 font-bold">點擊查看詳解 →</div>
                            </div>
                            <div class="text-3xl font-black text-emerald-500">${r.score}</div>
                        </div>
                    `).join('');
                } else list.innerHTML = '<div class="text-center py-10 text-slate-400 bg-white rounded-xl">尚無考試紀錄</div>';
            } catch (e) { list.innerHTML = '<div class="text-center py-10 text-red-400">載入成績紀錄失敗</div>'; }
        }

        // --- 修正：處理詳解中的 JSON 解析錯誤與圖片顯示 ---
        function showExamDetail(index) {
            const record = historyData[index];
            if (!record) return;

            let details = [];
            try {
                // 檢查 details 是否存在且有效
                if (!record.details || record.details === "undefined") {
                    throw new Error("Missing detail data");
                }
                details = JSON.parse(record.details);
            } catch (e) {
                console.error("解析成績詳解失敗:", e);
                toast('此筆紀錄無詳細題目資料（可能是舊版考卷）', true);
                return;
            }

            const body = document.getElementById('detail-body');
            document.getElementById('detail-title').innerText = `${record.quizType} (${record.score}分)`;
            
            body.innerHTML = details.map((d, i) => {
                // 檢查是否有圖片 (支援 imageUrl 欄位)
                const imgHtml = (d.imageUrl || d.img) ? `<div class="mb-3"><img src="${d.imageUrl || d.img}" class="max-w-full h-auto rounded-lg mx-auto shadow-sm" onerror="this.style.display='none'"></div>` : '';
                
                return `
                <div class="p-4 rounded-xl border ${d.isCorrect ? 'border-emerald-100 bg-emerald-50/50' : 'border-red-100 bg-red-50/50'}">
                    <div class="font-bold mb-2 text-slate-800">${i+1}. ${d.question || d.title || '題目載入中'} ${d.isCorrect ? '✅' : '❌'}</div>
                    ${imgHtml}
                    <div class="text-sm space-y-1">
                        <p><span class="text-slate-400">您的答案：</span><span class="${d.isCorrect ? 'text-emerald-600' : 'text-red-600'} font-medium">${d.userAnswer}</span></p>
                        ${!d.isCorrect ? `<p><span class="text-slate-400">正確答案：</span><span class="text-emerald-600 font-medium">${Array.isArray(d.correctAnswer || d.answer) ? (d.correctAnswer || d.answer).join(', ') : (d.correctAnswer || d.answer)}</span></p>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function startQuizFlow() {
            const type = document.getElementById('quiz-type-select').value;
            if (!type) return toast('請選擇科目', true);
            document.getElementById('quiz-init').classList.add('hidden');
            document.getElementById('quiz-main').classList.remove('hidden');
            document.getElementById('quiz-content').innerHTML = '<p class="text-center py-10">考卷載入中...</p>';
            fetchSheetQuiz(type).then(data => { quizData = data; renderQuiz(); }).catch(() => toast('載入考卷失敗', true));
        }

        async function fetchSheetQuiz(type) {
            const [q1, q2] = await Promise.all([
                fetchSingleSheet(QUIZ_GIDS['隨堂']),
                fetchSingleSheet(QUIZ_GIDS[type])
            ]);
            return [...q1, ...q2];
        }

        async function fetchSingleSheet(gid) {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`);
            const text = await res.text();
            const data = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/)[1]);
            return data.table.rows.map(row => ({
                question: row.c[0]?.v, 
                type: row.c[1]?.v?.toLowerCase().trim(),
                options: row.c[2]?.v ? String(row.c[2].v).split(',').map(s => s.trim()) : [],
                answer: String(row.c[3]?.v || '').split(',').map(s => s.trim()),
                score: parseFloat(row.c[4]?.v || 0), 
                imageUrl: row.c[5]?.v || '' // F 欄是圖片
            })).filter(q => q.question);
        }

        function renderQuiz() {
            const quizSubject = document.getElementById('quiz-type-select').value;
            let html = `<div class="bg-emerald-50 p-4 rounded-xl mb-4 text-emerald-800 text-sm font-bold text-center shadow-inner">正在測驗：隨堂 + ${quizSubject}</div>`;
            
            quizData.forEach((q, i) => {
                const qId = `q${i+1}`;
                let optHtml = '';
                
                // 修正：處理圖片顯示
                const imgHtml = q.imageUrl ? `<div class="mb-4 text-center"><img src="${q.imageUrl}" class="max-w-full h-auto rounded-xl mx-auto shadow-sm border border-slate-100" onerror="this.style.display='none'"></div>` : '';

                if(q.type !== 'fill') {
                    const shuffled = [...q.options].sort(()=>Math.random()-0.5);
                    optHtml = shuffled.map(o => `
                        <label class="hover:bg-slate-50 transition-colors">
                            <input type="${q.type==='single'?'radio':'checkbox'}" name="${qId}" value="${o}" class="mr-3 w-5 h-5 text-emerald-600 border-slate-300 focus:ring-emerald-500">
                            <span class="text-slate-700">${o}</span>
                        </label>
                    `).join('');
                } else {
                    optHtml = `<input type="text" class="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm" data-qid="${qId}" placeholder="請在此輸入答案">`;
                }

                html += `
                    <div class="question-card p-6 rounded-xl shadow-sm mb-6 bg-white border border-slate-100" id="${qId}">
                        <h3 class="font-bold mb-4 text-slate-800 text-lg leading-relaxed">${i+1}. ${q.question}</h3>
                        ${imgHtml}
                        <div class="options space-y-2">${optHtml}</div>
                    </div>
                `;
            });
            html += `<button onclick="handleQuizSubmit()" id="quiz-final-btn" class="w-full py-4 btn-primary rounded-xl font-bold text-lg mb-10 shadow-lg">確認交卷</button>`;
            document.getElementById('quiz-content').innerHTML = html;
            window.scrollTo(0,0);
        }

        async function handleQuizSubmit() {
            const btn = document.getElementById('quiz-final-btn'); 
            btn.disabled = true;
            btn.innerText = '正在處理並儲存成績...';
            const answers = quizData.map((q, i) => {
                const el = document.getElementById(`q${i+1}`);
                let val = '未作答';
                if (q.type === 'single') {
                    const checked = el.querySelector('input:checked');
                    val = checked ? checked.value : '未作答';
                } else if (q.type === 'multiple') {
                    val = Array.from(el.querySelectorAll('input:checked')).map(i => i.value).sort().join(', ') || '未作答';
                } else {
                    val = el.querySelector('input')?.value.trim() || '未作答';
                }
                return { qId: `q${i+1}`, userAnswer: val };
            });
            try {
                const params = new URLSearchParams({ 
                    action: 'submitQuiz', 
                    group: currentUser.group, 
                    name: currentUser.name, 
                    quizType: document.getElementById('quiz-type-select').value, 
                    userAnswersJson: JSON.stringify(answers), 
                    quizDataJson: JSON.stringify(quizData) 
                });
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: params });
                const result = await res.json();
                if (result.success || result.status === 'success') {
                    toast('考卷提交成功，成績已存檔');
                    switchView('results');
                }
            } catch (e) { toast('提交失敗，請檢查網路連線', true); btn.disabled = false; btn.innerText = '確認交卷'; }
        }

        function closeDetailModal() { document.getElementById('detail-modal').style.display = 'none'; }
        function logout() { localStorage.removeItem('sh_user_secure'); location.reload(); }
        function updateDateDisplay() { document.getElementById('today-date').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); }
        function toast(msg, isError = false) { const box = document.getElementById('message-box'); box.innerText = msg; box.className = `fixed top-5 right-5 p-4 rounded-lg shadow-2xl text-white z-[1000] fade-in font-bold ${isError ? 'bg-red-500' : 'bg-emerald-500'}`; box.style.display = 'block'; setTimeout(() => box.style.display = 'none', 4000); }
    </script>
</body>
</html>
